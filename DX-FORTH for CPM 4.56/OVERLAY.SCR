\ Overlay - Information                                                                                                         These screens shows how to implement an overlay system for      DX-Forth.  It allows the creation of applications larger than   would otherwise be possible.                                                                                                    WARNING: when running or debugging programs using overlays,     do not attempt to execute a word in an overlay if that overlay  is not currently loaded - it will cause the system to crash.                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ Overlay - Load screen                                         forth definitions  decimal                                      application                                                                                                                     cr ." loading the overlay words... "   2 load                                                                                   cr ." now creating 3 overlays... "     4 load                                                                                   cr ." now testing it... "              test                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ Overlay - OSIZE OBASE OFILE LOAD-OVERLAY                      forth definitions  decimal                                      application                                                                                                                     variable OSIZE                    \ size of largest overlay     variable OBASE                    \ base address overlay        create OFILE  max-path 1+ allot   \ overlay filename                                                                            \ Load overlay                                                  : LOAD-OVERLAY ( c-addr u -- ior )                                2dup ofile place  r/o open-file  ?dup if nip end  >r            obase @  osize @  r@ read-file nip  r> close-file drop ;      -->                                                                                                                                                                                                                                                             \ Overlay - OVERLAY                                             system                                                          \ Save overlay to disk and discard segment memory               : OVERLAY ( <filename> -- )                                       token  r/w create-file abort" can't create overlay"             obase @  here over -  dup >r  rot >r                            dup  osize @  umax  osize !             \ update size           r@ write-file  r> close-file  or abort" can't write overlay"    r> recover ;                            \ discard             application                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ Overlay - Demo                                                application     \ MUST be located in application space             0 osize !    \ initial size                                  here obase !    \ overlay start address                                                                                         : WORD1 ( -- )  CR ." This is WORD1 from SAMPLE1.OVL" ;         overlay sample1.ovl                                                                                                             : WORD2 ( -- )  CR ." This is WORD2 from SAMPLE2.OVL" ;         overlay sample2.ovl                                                                                                             : WORD3 ( -- )  CR ." This is WORD3 from SAMPLE3.OVL" ;         overlay sample3.ovl                                                                                                             osize @ allot   \ reserve memory for overlays                   -->                                                             \ Overlay - Demo                                                \ Load overlay, handle any errors                               : OLOAD ( c-addr u -- )                                           load-overlay if                                                   cr ." Error loading overlay: "  ofile count type  abort       then ;                                                                                                                        \ Create loader for each overlay                                : OVERLAY1 ( -- )  s" sample1.ovl" oload ;                      : OVERLAY2 ( -- )  s" sample2.ovl" oload ;                      : OVERLAY3 ( -- )  s" sample3.ovl" oload ;                                                                                      \ Test the overlays                                             : TEST ( -- )  overlay1 word1  overlay2 word2  overlay3 word3 ;                                                                                                                                 