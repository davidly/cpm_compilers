\ Information                                                                                                                   Convert ascii text files to forth screens                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ Load - main screen                                            empty forth definitions decimal application                     warning on                                                                                                                      : TITLE ." TXT2BLK ver 1.5" cr ;                                                                                                cr ." Compiling: "  title  2 load                                                                                               cr ." Save to disk? "  y/n  [if]                                \  tally @  pad + #256 + limit s0 @ - +  set-limit                turnkey program TXT2BLK                                       [then]                                                                                                                                                                                                                                                                                                                          \ Load - defaults                                               variable TALLY  0 tally !           \ run-time memory tally     defer ?STOP   ' noop is ?stop       \ user abort check          defer CON-IO  ' bios-io is con-io   \ default console i/o mode  defer ONERROR ' noop is onerror     \ reset on-error handler    defer ONSTART ' noop is onstart     \ startup initialization                                                                    blk @ 1+ #screens 1- thru       \ load electives & application                                                                   ' ?stopkey is ?stop            \ enable user abort             \ ' dos-io is con-io             \ enable console redirection   \ ' delout +is onerror           \ delete outfile on error      \ wrtchk off                     \ disable overwrite check                                                                                                                                                                                                      \ Electives                                                     1 fload DOSLIB  \ DOSLIB library                                 _Errors        \ error handler                                 \ _Inout1        \ number output                                \ _Inout2        \ deferred output                              \ _Compare1      \ basic compare                                 _String1       \ basic strings                                 \ _String2       \ extra strings                                 _Parse1        \ cmdline parsing                                _Parse2        \ cmdline extra                                  _Files         \ default files                                 \ _Bread         \ buffer read char                             \ _Bread2        \ buffer read data/text                        \ _Bwrite        \ buffer write char                            \ _Bwrite2       \ buffer write data/text                                                                                       \ Help screen - HELP                                            : HELP ( -- )  dos-io  cr cr title                                cr ." Use: TXT2BLK [opt] file[.LST] [file[.SCR]][.ext]" cr      cr ." -W   wrap lines"                                          cr ." -Cn  #cols[,rows[,size]]"                                 cr ." -Rn  #rows"                                               cr ." -Bn  block size"                                          cr ." -P   page on empty '\\' line"                             cr                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ Help screen - HELP                                              cr ." default: truncate lines, 64x16 screen"                    cr                                                              cr ." Convert ASCII text files to Forth screens."               con-io  abort ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ Variables                                                     variable WRAP       \ line wrap flag                            variable ROW        \ count                                     variable #TRUNC     \ count                                     variable PO         \ paging mode                                                                                               integer #COLS       \ cols/screen                               integer #ROWS       \ rows/screen                               integer BLKSIZ      \ block size                                                                                                : B/SCR  ( -- n )  #cols #rows * ;     \ logical screen size    : BUFSIZ ( -- n )  blksiz b/scr max ;  \ screen buffer size                                                                                                                                                                                                                                                                     \ SETCOLS                                                       \ Set #cols, #rows, block size                                  : SETCOLS ( a u -- a' 0 )                                         firstnum if  0 of  #cols   then  to #cols                       nextnum  if  0 of  #rows   then  to #rows                       nextnum  if  0 of  blksiz  then  to blksiz                      then then then ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ SETOPT                                                        \ Set switch                                                    :noname ( a u char -- a' u' )                                     upcase                                                          [char] W  of  wrap on  end                                      [char] C  of  setcols  end                                      [char] R  of  /num to #rows  end                                [char] B  of  /num to blksiz  end                               [char] P  of  po on  end                                        .bad ;  is setopt                                                                                                                                                                                                                                                                                                                                                                                                                                             \ PARSEFN                                                       \ Parse filenames:  file[.AAA] [file][.BBB][.ext]               :noname ( -- )                                                    argv 0= if  help  then                                          s" LST" +ext  2dup ifile !fname  -path -ext                     argv if  2dup -ext nip  while  2nip  then                       s" SCR"  else  1 /string  then  +ext                            ofile !fname ;  is parsefn                                                                                                    \\ Parse filenames:  file[.AAA] [file[.BBB]]                    :noname ( -- )                                                    argv 0= if  help  then                                          s" LST" +ext  ifile !fname                                      argv 0= if  ifile @fname  -path -ext  then                      s" SCR" +ext  ofile !fname ;  is parsefn                                                                                      \ /ROWS ROW# GET CLEAN                                          \ Reset row counter                                             : /ROWS ( -- )  #rows row ! ;                                                                                                   \ Current row                                                   : ROW# ( -- n )  #rows  row @  - ;                                                                                              \ Read a line  false if EOF                                     : GET ( -- a u flag )                                             bufsiz ( for ultraForth)  pad +                                 #cols 4 *  ( avoid wrap gap on long lines)  readln ;                                                                          \ Convert tabs, trim trailing spaces                            : CLEAN ( a u -- a u' )  2dup >blanks  -trailing ;                                                                                                                                              \ ?TRUNC WRTBLK PUT PADBLK                                      \ Truncate line                                                 : ?TRUNC ( a u -- a u' )                                          wrap @ if end  #cols  2dup > if  1 #trunc +!  then  min ;                                                                     \ Write block                                                   : WRTBLK ( -- )  pad blksiz write  /rows ;                                                                                      \ Insert line                                                   : PUT ( a u -- )                                                  row @  0= if  wrtblk  then                                      row# #cols *  pad +  dup #cols blank  swap cmove  -1 row +! ;                                                                 \ Pad remainder of block with blanks or insert new              : PADBLK ( -- )                                                   row @  0 of  #rows  then  0 do  here 0 put  loop ;            \ FLUSHBLK PAGE? PROCLINE                                       \ Flush block if not empty                                      : FLUSHBLK ( -- )                                                 row @ #rows < if  padblk  wrtblk  then ;                                                                                      \ Test for sentinel                                             : PAGE? ( a u -- flag )                                           1 =  swap c@ [char] \ =  and  po @ and ;                                                                                      \ Process the line                                              : PROCLINE ( a u -- )                                             2dup page? if ( new) padblk  else                                 clean  ?trunc  ( a u)                                           begin  #cols over min  /split  put  dup 0= until              then  2drop ;                                                                                                                 \ .TRUNC COPYFILE                                               \ Notify any truncated lines                                    : .TRUNC ( -- )  #trunc @  ?dup                                   if  cr ." Warning - " u. ." lines truncated" cr  then ;                                                                       \ Copy loop                                                     : COPYFILE ( -- )                                                 /rows  #trunc off                                               begin  get while  procline  repeat 2drop  flushblk              .trunc ;                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ OPENFILES                                                     : OPENFILES ( -- )                                                cr ." i: " .ifile  r/o openin                                   cr ." o: " .ofile  r/w makeout                                  cr                                                            ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ (RUN)                                                         \ Run application                                               : (RUN) ( -- )                                                    openfiles                                                       copyfile                                                        closefiles                                                    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ DEFAULTS                                                      \ Set application defaults                                      : DEFAULTS ( -- )                                                 64 to #cols  16 to #rows  1024 to blksiz                        wrap off  po off                                              ;                                                                                                                               defaults                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ RUN PROGRAM                                                   \ Run application with error handling                           : RUN ( -- )                                                      ['] (run) catch ?dup if  >r onerror r> throw  then ;                                                                          \ Main                                                          : PROGRAM ( -- )                                                  onstart           \ startup initialization                      con-io            \ default console mode                        defaults          \ set defaults                                cr title          \ show application name                       cmdtail parsecmd  \ process command-line                        run               \ run application                             cr ." done"       \ show success                              ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               