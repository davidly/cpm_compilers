\ Information                                                                                                                   Convert forth screen files to ascii text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ Load - main screen                                            empty forth definitions decimal application                     warning on                                                                                                                      : TITLE ." BLK2TXT ver 1.6" cr ;                                                                                                cr ." Compiling: "  title  2 load                                                                                               cr ." Save to disk? "  y/n  [if]                                \  tally @  pad + #256 + limit s0 @ - +  set-limit                turnkey program BLK2TXT                                       [then]                                                                                                                                                                                                                                                                                                                          \ Load - defaults                                               variable TALLY  0 tally !           \ run-time memory tally     defer ?STOP   ' noop is ?stop       \ user abort check          defer CON-IO  ' bios-io is con-io   \ default console i/o mode  defer ONERROR ' noop is onerror     \ reset on-error handler    defer ONSTART ' noop is onstart     \ startup initialization                                                                    blk @ 1+ #screens 1- thru       \ load electives & application                                                                   ' ?stopkey is ?stop            \ enable user abort             \ ' dos-io is con-io             \ enable console redirection   \ ' delout +is onerror           \ delete outfile on error      \ wrtchk off                     \ disable overwrite check                                                                                                                                                                                                      \ Electives                                                     1 fload DOSLIB  \ DOSLIB library                                 _Errors        \ error handler                                 \ _Inout1        \ number output                                \ _Inout2        \ deferred output                              \ _Compare1      \ basic compare                                 _String1       \ basic strings                                 \ _String2       \ extra strings                                 _Parse1        \ cmdline parsing                                _Parse2        \ cmdline extra                                  _Files         \ default files                                 \ _Bread         \ buffer read char                             \ _Bread2        \ buffer read data/text                        \ _Bwrite        \ buffer write char                            \ _Bwrite2       \ buffer write data/text                                                                                       \ Help screen - HELP                                            : HELP ( -- )  dos-io  cr cr title                                cr ." Use: BLK2TXT [opt] file[.SCR] [file[.LST]][.ext]" cr      cr ." -F[n] formatted [offset]"                                 cr ." -Cn   #cols[,rows[,size]]"                                cr ." -Rn   #rows"                                              cr ." -Bn   block size"                                         cr ." -O    compact [.PRN]"                                     cr                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ Help screen - HELP                                              cr ." default: unformatted, 64x16 screen"                       cr                                                              cr ." Convert Forth screen files to ASCII text."                con-io  abort ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ Variables                                                     variable FMT        \ formatted flag                            variable ROW        \ count                                     variable SCREEN     \ count                                     variable COMPACT    \ flag                                      variable BLANKS     \ count                                                                                                     integer #OFFS       \ screen offset to print                    integer #COLS       \ cols/screen                               integer #ROWS       \ rows/screen                               integer BLKSIZ      \ block size                                                                                                : INIT   ( -- )    #rows row !  -1 screen ! ;                   : B/SCR  ( -- n )  #cols #rows * ;     \ logical screen size    : BUFSIZ ( -- n )  blksiz b/scr max ;  \ screen buffer size                                                                     \ SETCOLS SETFMT ?BUMP                                          \ Set #cols, #rows, block size                                  : SETCOLS ( a u -- a' 0 )                                         firstnum if  0 of  #cols   then  to #cols                       nextnum  if  0 of  #rows   then  to #rows                       nextnum  if  0 of  blksiz  then  to blksiz                      then then then ;                                                                                                              : SETFMT ( a u -- a' 0 )                                          firstnum if  to #offs  then  fmt on ;                                                                                         \ Bump blank lines count                                        : ?BUMP ( a u -- a u )                                            dup if  blanks off  end  1 blanks +! ;                                                                                                                                                        \ 0CMT? BLKCMT? PRINT?                                          \ Row 0 is comment?                                             : 0CMT? ( a u -- f )                                              [char] \ scan  2over d=  row @ 0=  and ;                                                                                      \ Block comment line?                                           : BLKCMT? ( a u f -- a u|0 f )                                    2dup 0cmt? >r                                                   blanks @ 0=  r@ and if  \ prev not blank                          drop 0  2dup writeln  \ add blank line                        then  ?bump  r> ;                                                                                                             : PRINT? ( a u -- a u|0 f )                                       compact @ if                                                      blkcmt?  blanks @ 1 >  or  not                                end  true ;                                                   \ SETOPT                                                        \ Set switch                                                    :noname ( a u char -- a' u' )                                     upcase                                                          [char] F  of  setfmt  compact off  end                          [char] C  of  setcols  end                                      [char] R  of  /num to #rows  end                                [char] B  of  /num to blksiz  end                               [char] O  of  compact on  fmt off  end                          .bad ;  is setopt                                                                                                                                                                                                                                                                                                                                                                                                                                             \ PARSEFN                                                       \ Parse filenames:  file[.AAA] [file[.BBB]][.ext]               :noname ( -- )                                                    argv 0= if  help  then                                          s" SCR" +ext  2dup ifile !fname  -path -ext                     argv if  2dup -ext nip  while  2nip  then                       compact @ if  s" PRN"  else  s" LST"  then                      else  1 /string  then  +ext                                     ofile !fname ;  is parsefn                                                                                                    \\ Parse filenames:  file[.AAA] [file[.BBB]]                    :noname ( -- )                                                    argv 0= if  help  then                                          s" SCR" +ext  ifile !fname                                      argv 0= if  ifile @fname  -path -ext  then                      s" LST" +ext  ofile !fname ;  is parsefn                      \ HEADER PUT                                                    \ Write screen/line numbering                                   : HEADER ( -- )                                                   row @  dup 0= if  \ new screen                                    (cr) write  s"    " write                                       screen @  #offs +  (u.) writeln                               then  (u.) 2 (s.r) write  s"  " write ;                                                                                       \ Write a line                                                  : PUT ( a u -- )                                                  print? if                                                         fmt @ if header then  writeln                                 else  2drop  then  1 row +! ;                                                                                                                                                                                                                                 \ GETBLK GET COPYFILE                                           \ Read next block                                               : GETBLK ( flag -- flag' )                                        pad  dup bufsiz blank  ( for ultraForth)                        blksiz read  nip 0<> and  1 screen +! ;                                                                                       \ Get next line                                                 : GET ( -- a u flag )                                             true  row @  #rows  of  getblk  0  then  dup row !              #cols *  pad +  #cols  -trailing  rot ;                                                                                       \ Copy loop                                                     : COPYFILE ( -- )                                                 init  begin  get while  put  repeat 2drop ;                                                                                                                                                   \ OPENFILES                                                     : OPENFILES ( -- )                                                cr ." i: " .ifile  r/o openin                                   cr ." o: " .ofile  r/w makeout                                  cr                                                            ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ (RUN)                                                         \ Run application                                               : (RUN) ( -- )                                                    openfiles                                                       copyfile                                                        closefiles                                                    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ DEFAULTS                                                      \ Set application defaults                                      : DEFAULTS ( -- )                                                 64 to #cols  16 to #rows  1024 to blksiz  0 to #offs            fmt off  compact off                                          ;                                                                                                                               defaults                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ RUN PROGRAM                                                   \ Run application with error handling                           : RUN ( -- )                                                      ['] (run) catch ?dup if  >r onerror r> throw  then ;                                                                          \ Main                                                          : PROGRAM ( -- )                                                  onstart           \ startup initialization                      con-io            \ default console mode                        defaults          \ set defaults                                cr title          \ show application name                       cmdtail parsecmd  \ process command-line                        run               \ run application                             cr ." done"       \ show success                              ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               